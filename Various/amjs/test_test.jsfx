desc: MIDI Events First
@init
DELAY = 0.001; // 延迟时间为0.1秒
PC_MSG = 0xC0; // PC事件的MIDI消息类型
CC_MSG = 0xB0; // CC事件的MIDI消息类型
CC119_NUM = 119; // CC119的控制器编号

MSG_BUF = 128;
buffer = 0;
memset(0, 0, MSG_BUF);
n_buf = 0;

@block
while (
midirecv(mpos, msg1, msg2, msg3) ? (
msg = msg1 & 0xF0;
cc_num = msg2;

(msg != CC_MSG || cc_num != CC119_NUM) ? (
// 如果不是CC119事件,延迟0.1秒
mpos += DELAY * srate;
);

buffer[MSG_BUF+n_buf] = mpos;
buffer[MSG_BUF+n_buf+1] = msg1;
buffer[MSG_BUF+n_buf+2] = msg2;
buffer[MSG_BUF+n_buf+3] = msg3;
n_buf += 4;
);
);

// 播放缓冲区中已到时间的事件
i = 0;
while (
(i < n_buf) ? (
mpos = buffer[MSG_BUF + i];

(mpos < samplesblock) ? (
midisend(mpos, buffer[MSG_BUF+i+1], buffer[MSG_BUF+i+2], buffer[MSG_BUF+i+3]);
memcpy(MSG_BUF+i, MSG_BUF+i+4, n_buf-i);
n_buf -= 4;
) : (
buffer[MSG_BUF+i] -= samplesblock;
i += 4;
);
);
);
